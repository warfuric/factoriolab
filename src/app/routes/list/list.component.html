<ng-container *ngIf="vm$ | async as vm">
  <table *ngIf="vm.steps.length">
    <thead>
      <tr class="border col">
        <!-- Expand -->
        <th>
          <div class="flex end">
            <lab-columns>
              <button
                [title]="'list.setColumnsVisibilityAndPrecision' | translate"
              >
                <i class="material-icons">settings</i>
              </button></lab-columns
            >
          </div>
        </th>
        <th *ngIf="vm.columns[Column.Tree].show">
          <div class="header">{{ 'list.tree' | translate }}</div>
        </th>
        <th class="num-icon">
          <div class="header">
            {{ 'list.items' | translate
            }}{{ vm.settings.displayRate | displayRateLabel }}
            <button
              *ngIf="vm.itemsModified.ignore"
              [title]="'list.itemsTitle' | translate"
              (click)="resetIgnore()"
            >
              <i class="material-icons">undo</i>
            </button>
          </div>
        </th>
        <th class="num-icon" *ngIf="vm.columns[Column.Belts].show">
          <div class="header">
            {{ 'list.belts' | translate }}
            <button
              *ngIf="vm.itemsModified.belts"
              [title]="'list.beltsTitle' | translate"
              (click)="resetBelt()"
            >
              <i class="material-icons">undo</i>
            </button>
          </div>
        </th>
        <th class="num-icon" *ngIf="vm.columns[Column.Wagons].show">
          <div class="header">
            {{ 'list.wagons' | translate
            }}{{ vm.settings.displayRate | displayRateLabel }}
            <button
              *ngIf="vm.itemsModified.wagons"
              [title]="'list.wagonsTitle' | translate"
              (click)="resetWagon()"
            >
              <i class="material-icons">undo</i>
            </button>
          </div>
        </th>
        <th colspan="3">
          <div class="header">
            {{ 'list.factories' | translate }}
            <button
              *ngIf="vm.recipesModified.factories"
              [title]="'list.factoriesTitle' | translate"
              (click)="resetFactory()"
            >
              <i class="material-icons">undo</i>
            </button>
          </div>
        </th>
        <th *ngIf="vm.columns[Column.Overclock].show">
          <div class="header">
            {{ 'list.overclock' | translate }}
            <button
              *ngIf="vm.recipesModified.overclock"
              [title]="'list.overclockTitle' | translate"
              (click)="resetOverclock()"
            >
              <i class="material-icons">undo</i>
            </button>
          </div>
        </th>
        <th *ngIf="vm.columns[Column.Beacons].show" colspan="3">
          <div class="header">
            <span *ngIf="vm.settings.beaconReceivers" class="sub left">{{
              'list.each' | translate
            }}</span>
            <span>{{ 'list.beacons' | translate }}</span>
            <button
              *ngIf="vm.recipesModified.beacons"
              [title]="'list.beaconsTitle' | translate"
              (click)="resetBeacons()"
            >
              <i class="material-icons">undo</i>
            </button>
            <span *ngIf="vm.settings.beaconReceivers" class="sub right">{{
              'list.total' | translate
            }}</span>
          </div>
        </th>
        <th class="num-unit" *ngIf="vm.columns[Column.Power].show">
          <div class="header">{{ 'list.power' | translate }}</div>
        </th>
        <th *ngIf="vm.columns[Column.Pollution].show">
          <div class="header">
            {{ 'list.pollution' | translate
            }}{{ vm.settings.displayRate | displayRateLabel }}
          </div>
        </th>
        <!-- Reset / Link -->
        <th *ngIf="vm.columns[Column.Link].show && mode === ListMode.All">
          <button
            [title]="'list.downloadTitle' | translate"
            data-test="lab-list-export"
            (click)="
              export(
                vm.steps,
                vm.itemSettings,
                vm.recipeSettings,
                vm.columns,
                vm.data
              )
            "
          >
            <i class="material-icons">file_download</i>
          </button>
        </th>
      </tr>
    </thead>
    <tbody *ngIf="vm.columns[Column.Tree].show ? 2 : 1 as leftSpan">
      <ng-container *ngFor="let step of vm.steps; trackBy: trackSvc.trackById">
        <ng-container
          *ngIf="
            mode === ListMode.All ||
            (selectedId != null && step.id === selectedId)
          "
        >
          <tr class="border row col">
            <td [id]="step.itemId">
              <div>
                <ng-container *ngIf="vm.stepDetails[step.id].tabs as tabs">
                  <button
                    *ngIf="tabs.length && !expanded[step.id]"
                    [title]="'list.clickToShowDetails' | translate"
                    (click)="expanded[step.id] = tabs[0]"
                  >
                    <i class="material-icons">expand_more</i>
                  </button>
                </ng-container>
                <button
                  *ngIf="mode === ListMode.All && expanded[step.id]"
                  [title]="'list.clickToHideDetails' | translate"
                  (click)="expanded[step.id] = StepDetailTab.None"
                >
                  <i class="material-icons">expand_less</i>
                </button>
              </div>
            </td>
            <td *ngIf="vm.columns[Column.Tree].show" class="tree">
              <div class="flex links">
                <ng-container *ngIf="vm.stepTree[step.id]?.length">
                  <div
                    *ngFor="let i of vm.stepTree[step.id]; last as last"
                    class="connect"
                    [class.trail]="i"
                    [class.last]="last"
                  ></div>
                  <div class="indent"></div>
                </ng-container>
                <lab-icon
                  *ngIf="step.itemId; else recipeIcon"
                  [iconId]="step.itemId"
                  [tooltip]="vm.data.itemEntities[step.itemId].name"
                  [recipe]="
                    vm.data.recipeEntities[vm.data.itemRecipeId[step.itemId]]
                  "
                >
                </lab-icon>
                <ng-template #recipeIcon>
                  <lab-icon
                    *ngIf="step.recipeId"
                    [iconId]="step.recipeId"
                    [tooltip]="vm.data.recipeEntities[step.recipeId].name"
                    [recipe]="vm.data.recipeEntities[step.recipeId]"
                  >
                  </lab-icon>
                </ng-template>
              </div>
            </td>
            <td>
              <div class="flex" *ngIf="step.itemId && step.items">
                <span
                  *ngIf="step.surplus && step.surplus.nonzero()"
                  class="monospace"
                  >(+{{
                    step.surplus | rate: vm.effectivePrecision[Column.Surplus]
                  }})</span
                >
                <span *ngIf="step.items" class="monospace">{{
                  step.items.sub(step.surplus || Rational.zero)
                    | rate: vm.effectivePrecision[Column.Items]
                }}</span>
                <lab-icon
                  class="button"
                  [title]="
                    vm.itemSettings[step.itemId].ignore
                      ? 'list.clickToInclude'
                      : ('list.clickToIgnore' | translate)
                  "
                  [iconId]="step.itemId"
                  [class.ignored]="vm.itemSettings[step.itemId].ignore"
                  [tooltip]="vm.data.itemEntities[step.itemId].name"
                  [recipe]="
                    vm.data.recipeEntities[vm.data.itemRecipeId[step.itemId]]
                  "
                  [hoverIcon]="
                    vm.itemSettings[step.itemId].ignore
                      ? 'visibility'
                      : 'visibility_off'
                  "
                  (click)="ignoreItem(step.itemId)"
                ></lab-icon>
              </div>
            </td>
            <td *ngIf="vm.columns[Column.Belts].show">
              <ng-container *ngIf="step.itemId && step.belts">
                <div
                  *ngIf="vm.itemSettings[step.itemId].beltId as beltId"
                  class="flex"
                >
                  <span class="monospace">{{
                    step.belts | rate: vm.effectivePrecision[Column.Belts]
                  }}</span>
                  <ng-container
                    *ngIf="
                      vm.data.beltIds.indexOf(beltId) !== -1;
                      else pipePicker
                    "
                  >
                    <lab-select
                      *ngIf="vm.settings.beltId"
                      [header]="'list.selectABelt' | translate"
                      [selected]="beltId"
                      [options]="vm.data.beltIds"
                      [columns]="
                        vm.data.game === Game.DysonSphereProgram ? 3 : null
                      "
                      (selectId)="
                        setBelt(step.itemId, $event, vm.settings.beltId)
                      "
                    >
                      <lab-icon
                        class="button"
                        [title]="'list.clickToChangeBelt' | translate"
                        [iconId]="beltId"
                        [tooltip]="vm.data.itemEntities[beltId].name"
                        [item]="vm.data.itemEntities[beltId]"
                      ></lab-icon>
                    </lab-select>
                  </ng-container>
                  <ng-template #pipePicker>
                    <ng-container
                      *ngIf="
                        vm.data.pipeIds.indexOf(beltId) !== -1;
                        else pipeIcon
                      "
                    >
                      <lab-select
                        *ngIf="vm.settings.pipeId"
                        [header]="'list.selectAPipe' | translate"
                        [selected]="beltId"
                        [options]="vm.data.pipeIds"
                        (selectId)="
                          setBelt(step.itemId, $event, vm.settings.pipeId)
                        "
                      >
                        <lab-icon
                          class="button"
                          [title]="'list.clickToChangePipe' | translate"
                          [iconId]="beltId"
                          [tooltip]="vm.data.itemEntities[beltId].name"
                          [item]="vm.data.itemEntities[beltId]"
                        ></lab-icon>
                      </lab-select>
                    </ng-container>
                  </ng-template>
                  <ng-template #pipeIcon>
                    <lab-icon
                      [iconId]="beltId"
                      [tooltip]="vm.data.itemEntities[beltId]?.name || PIPE"
                    ></lab-icon>
                  </ng-template>
                </div>
              </ng-container>
            </td>
            <td *ngIf="vm.columns[Column.Wagons].show">
              <ng-container *ngIf="step.itemId && step.wagons">
                <div
                  *ngIf="vm.itemSettings[step.itemId].wagonId as wagonId"
                  class="flex"
                >
                  <span class="monospace">{{
                    step.wagons | rate: vm.effectivePrecision[Column.Wagons]
                  }}</span>
                  <ng-container
                    *ngIf="
                      vm.data.fluidWagonIds.indexOf(wagonId) === -1;
                      else fluidWagon
                    "
                  >
                    <ng-container
                      *ngIf="
                        vm.data.cargoWagonIds.length > 1;
                        else wagonDefault
                      "
                    >
                      <lab-select
                        *ngIf="vm.settings.cargoWagonId"
                        [header]="'list.selectACargoWagon' | translate"
                        [selected]="wagonId"
                        [options]="vm.data.cargoWagonIds"
                        (selectId)="
                          setWagon(
                            step.itemId,
                            $event,
                            vm.settings.cargoWagonId
                          )
                        "
                      >
                        <lab-icon
                          class="button"
                          [title]="'list.clickToChangeCargoWagon' | translate"
                          [iconId]="wagonId"
                          [tooltip]="vm.data.itemEntities[wagonId].name"
                          [item]="vm.data.itemEntities[wagonId]"
                        ></lab-icon>
                      </lab-select>
                    </ng-container>
                  </ng-container>
                  <ng-template #fluidWagon>
                    <ng-container
                      *ngIf="
                        vm.data.fluidWagonIds.length > 1;
                        else wagonDefault
                      "
                    >
                      <lab-select
                        *ngIf="vm.settings.fluidWagonId"
                        [header]="'list.selectAFluidWagon' | translate"
                        [selected]="wagonId"
                        [options]="vm.data.fluidWagonIds"
                        (selectId)="
                          setWagon(
                            step.itemId,
                            $event,
                            vm.settings.fluidWagonId
                          )
                        "
                      >
                        <lab-icon
                          class="button"
                          [title]="'list.clickToChangeFluidWagon' | translate"
                          [iconId]="wagonId"
                          [tooltip]="vm.data.itemEntities[wagonId].name"
                          [item]="vm.data.itemEntities[wagonId]"
                        ></lab-icon>
                      </lab-select>
                    </ng-container>
                  </ng-template>
                  <ng-template #wagonDefault>
                    <lab-icon
                      [iconId]="wagonId"
                      [tooltip]="vm.data.itemEntities[wagonId].name"
                      [item]="vm.data.itemEntities[wagonId]"
                    ></lab-icon>
                  </ng-template>
                </div>
              </ng-container>
            </td>
            <ng-container *ngIf="step.recipeId; else noRecipeCell">
              <ng-container
                *ngIf="vm.recipeSettings[step.recipeId].factoryId as factory"
              >
                <td class="num" [id]="step.recipeId">
                  <div
                    *ngIf="step.factories && step.factories.nonzero()"
                    class="flex"
                  >
                    <span class="monospace">{{
                      step.factories
                        | factoryRate
                          : vm.effectivePrecision[Column.Factories]
                          : factory
                    }}</span>
                  </div>
                </td>
                <td class="recipe-icon split-column">
                  <div>
                    <div class="flex">
                      <lab-icon
                        [iconId]="step.recipeId"
                        [tooltip]="vm.data.recipeEntities[step.recipeId].name"
                        [recipe]="vm.data.recipeEntities[step.recipeId]"
                      ></lab-icon>
                      <ng-container
                        *ngIf="vm.data.recipeEntities[step.recipeId] as recipe"
                      >
                        <ng-container
                          *ngIf="
                            vm.data.game !== Game.DysonSphereProgram ||
                            factory !== ItemId.MiningDrill
                          "
                        >
                          <ng-container
                            *ngIf="
                              recipe.producers && recipe.producers.length > 1;
                              else factoryDefault
                            "
                          >
                            <lab-select
                              [header]="'list.selectAFactory' | translate"
                              [selected]="factory"
                              [options]="recipe.producers"
                              (selectId)="
                                changeFactory(
                                  step.recipeId,
                                  $event,
                                  vm.factories,
                                  vm.data
                                )
                              "
                            >
                              <lab-icon
                                class="button"
                                [title]="
                                  'list.clickToChangeFactory' | translate
                                "
                                [iconId]="factory"
                                [tooltip]="vm.data.itemEntities[factory].name"
                                [item]="vm.data.itemEntities[factory]"
                              ></lab-icon>
                            </lab-select>
                          </ng-container>
                          <ng-template #factoryDefault>
                            <lab-icon
                              [iconId]="factory"
                              [tooltip]="vm.data.itemEntities[factory].name"
                              [item]="vm.data.itemEntities[factory]"
                            ></lab-icon>
                          </ng-template>
                        </ng-container>
                      </ng-container>
                    </div>
                  </div>
                </td>
                <td class="split-column">
                  <div class="flex">
                    <div
                      *ngIf="
                        vm.recipeSettings[step.recipeId]
                          .factoryModuleIds as moduleIds
                      "
                      class="flex mod"
                    >
                      <lab-select
                        *ngFor="
                          let mod of moduleIds;
                          index as i;
                          first as first
                        "
                        [header]="
                          (vm.data.game === Game.Factorio
                            ? 'list.selectAModule'
                            : vm.data.game === Game.DysonSphereProgram
                            ? 'list.selectAProliferator'
                            : 'list.selectResourcePurity'
                          ) | translate
                        "
                        [selected]="mod"
                        [options]="vm.data.recipeModuleIds[step.recipeId]"
                        [includeEmptyModule]="
                          vm.data.game !== Game.Satisfactory
                        "
                        (selectId)="
                          changeRecipeField(
                            step.recipeId,
                            $event,
                            vm.recipeSettings,
                            vm.factories,
                            RecipeField.FactoryModules,
                            i,
                            vm.data
                          )
                        "
                      >
                        <lab-icon
                          class="button module"
                          [title]="
                            (vm.data.game === Game.Factorio
                              ? 'list.clickToChangeFactoryModules'
                              : vm.data.game === Game.DysonSphereProgram
                              ? 'list.clickToChangeProliferator'
                              : 'list.clickToChangeResourcePurity'
                            ) | translate
                          "
                          [iconId]="mod"
                          [tooltip]="vm.data.itemEntities[mod]?.name"
                          [item]="vm.data.itemEntities[mod]"
                        ></lab-icon>
                      </lab-select>
                    </div>
                  </div>
                </td>
              </ng-container>
            </ng-container>
            <td *ngIf="vm.columns[Column.Overclock].show">
              <ng-container *ngIf="step.recipeId">
                <input
                  *ngIf="vm.recipeSettings[step.recipeId]"
                  type="number"
                  [title]="'list.setOverclock' | translate"
                  placeholder="100"
                  min="0"
                  max="250"
                  step="10"
                  labValidateOverclock
                  [ngModel]="vm.recipeSettings[step.recipeId].overclock"
                  (input)="
                    changeRecipeField(
                      step.recipeId,
                      $event,
                      vm.recipeSettings,
                      vm.factories,
                      RecipeField.Overclock
                    )
                  "
                />
                %
              </ng-container>
            </td>
            <ng-container *ngIf="vm.columns[Column.Beacons].show">
              <ng-container *ngIf="step.recipeId; else noRecipeCell">
                <ng-container
                  *ngIf="
                    vm.recipeSettings[step.recipeId].beaconId as beaconId;
                    else noRecipeCell
                  "
                >
                  <td>
                    <div
                      *ngIf="
                        vm.recipeSettings[step.recipeId].beaconCount as count
                      "
                      class="flex"
                    >
                      <lab-input
                        [title]="'list.setNumberOfBeacons' | translate"
                        placeholder="# Beacons"
                        [digits]="2"
                        [value]="count"
                        (setValue)="
                          changeRecipeField(
                            step.recipeId,
                            $event,
                            vm.recipeSettings,
                            vm.factories,
                            RecipeField.BeaconCount
                          )
                        "
                      >
                      </lab-input>
                    </div>
                  </td>
                  <td class="split-column">
                    <div class="flex">
                      <ng-container
                        *ngIf="
                          vm.recipeSettings[step.recipeId].beaconCount | gtZero
                        "
                      >
                        <ng-container
                          *ngIf="
                            vm.data.beaconIds.length === 1;
                            else beaconPicker
                          "
                        >
                          <lab-icon
                            [iconId]="beaconId"
                            [tooltip]="vm.data.itemEntities[beaconId].name"
                            [item]="vm.data.itemEntities[beaconId]"
                          ></lab-icon
                        ></ng-container>
                        <ng-template #beaconPicker>
                          <lab-select
                            [header]="'list.selectABeacon' | translate"
                            [selected]="beaconId"
                            [options]="vm.data.beaconIds"
                            (selectId)="
                              changeRecipeField(
                                step.recipeId,
                                $event,
                                vm.recipeSettings,
                                vm.factories,
                                RecipeField.Beacon
                              )
                            "
                          >
                            <lab-icon
                              class="button"
                              [title]="'list.clickToChangeBeacon' | translate"
                              [iconId]="beaconId"
                              [tooltip]="vm.data.itemEntities[beaconId].name"
                              [item]="vm.data.itemEntities[beaconId]"
                            ></lab-icon>
                          </lab-select>
                        </ng-template>
                      </ng-container>
                    </div>
                  </td>
                  <td class="split-column">
                    <ng-container
                      *ngIf="
                        vm.recipeSettings[step.recipeId].beaconCount | gtZero
                      "
                    >
                      <div class="flex">
                        <div
                          *ngIf="
                            vm.recipeSettings[step.recipeId]
                              ?.beaconModuleIds as moduleIds
                          "
                          class="flex mod"
                        >
                          <lab-select
                            *ngFor="
                              let mod of moduleIds;
                              index as i;
                              first as first
                            "
                            [header]="'list.selectAModule' | translate"
                            [selected]="mod"
                            [options]="vm.data.beaconModuleIds"
                            [includeEmptyModule]="true"
                            (selectId)="
                              changeRecipeField(
                                step.recipeId,
                                $event,
                                vm.recipeSettings,
                                vm.factories,
                                RecipeField.BeaconModules,
                                i,
                                vm.data
                              )
                            "
                          >
                            <lab-icon
                              class="button module"
                              [title]="
                                'list.clickToChangeBeaconModules' | translate
                              "
                              [iconId]="mod"
                              [tooltip]="vm.data.itemEntities[mod]?.name"
                              [item]="vm.data.itemEntities[mod]"
                            ></lab-icon>
                          </lab-select>
                        </div>
                        <div *ngIf="step.beacons">
                          <lab-input
                            [title]="'list.setTotalBeacons' | translate"
                            placeholder="# Beacons"
                            [digits]="4"
                            [value]="step.beacons.toString()"
                            (setValue)="setBeaconTotal(step.recipeId, $event)"
                          >
                          </lab-input>
                        </div>
                      </div>
                    </ng-container>
                  </td>
                </ng-container>
              </ng-container>
            </ng-container>
            <ng-template #noRecipeCell>
              <td colspan="3"></td>
            </ng-template>
            <td *ngIf="vm.columns[Column.Power].show">
              <div *ngIf="step.power && step.power.nonzero()" class="flex">
                <span class="monospace">{{
                  step.power
                    | power
                      : vm.effectivePrecision[Column.Power]
                      : vm.effectivePowerUnit
                }}</span>
              </div>
            </td>
            <td *ngIf="vm.columns[Column.Pollution].show">
              <div
                *ngIf="step.pollution && step.pollution.nonzero()"
                class="flex"
              >
                <span class="monospace">{{
                  step.pollution | rate: vm.effectivePrecision[Column.Pollution]
                }}</span>
              </div>
            </td>
            <td class="nowrap" *ngIf="vm.columns[Column.Link].show">
              <div class="flex links">
                <a
                  *ngIf="step.items"
                  class="button"
                  [title]="'list.clickToOpenThisStepInANewTab' | translate"
                  [href]="step | stepHref: vm.data"
                  target="_blank"
                >
                  <i class="clickable material-icons">open_in_new</i>
                </a>
                <button
                  *ngIf="
                    (step.recipeId &&
                      vm.stepsModified.recipes[step.recipeId]) ||
                    (step.itemId && vm.stepsModified.items[step.itemId])
                  "
                  [title]="'list.undoModificationsToThisStep' | translate"
                  data-test="lab-list-reset-step"
                  (click)="resetStep(step)"
                >
                  <i class="material-icons">undo</i>
                </button>
              </div>
            </td>
          </tr>
          <ng-container *ngIf="expanded[step.id]">
            <tr class="detail-header">
              <td [colSpan]="leftSpan">
                <div class="flex">
                  <a class="button" [href]="'#' + step.id">
                    <i class="material-icons">link</i>
                  </a>
                </div>
              </td>
              <td colspan="100" class="detail-tabs">
                <ul class="tabs">
                  <li
                    *ngIf="
                      vm.stepDetails[step.id].tabs.indexOf(
                        StepDetailTab.Item
                      ) !== -1
                    "
                    [class.active]="expanded[step.id] === StepDetailTab.Item"
                    (click)="expanded[step.id] = StepDetailTab.Item"
                  >
                    <span>{{ 'list.item' | translate }}</span>
                  </li>
                  <li
                    *ngIf="
                      vm.stepDetails[step.id].tabs.indexOf(
                        StepDetailTab.Recipe
                      ) !== -1
                    "
                    [class.active]="expanded[step.id] === StepDetailTab.Recipe"
                    (click)="expanded[step.id] = StepDetailTab.Recipe"
                  >
                    <span>{{ 'list.recipe' | translate }}</span>
                  </li>
                  <li
                    *ngIf="
                      vm.stepDetails[step.id].tabs.indexOf(
                        StepDetailTab.Factory
                      ) !== -1
                    "
                    [class.active]="expanded[step.id] === StepDetailTab.Factory"
                    (click)="expanded[step.id] = StepDetailTab.Factory"
                  >
                    <span>{{ 'list.factory' | translate }}</span>
                  </li>
                  <li
                    *ngIf="
                      vm.stepDetails[step.id].tabs.indexOf(
                        StepDetailTab.Recipes
                      ) !== -1
                    "
                    [class.active]="expanded[step.id] === StepDetailTab.Recipes"
                    (click)="expanded[step.id] = StepDetailTab.Recipes"
                  >
                    <span>{{ 'list.recipes' | translate }}</span>
                  </li>
                </ul>
              </td>
            </tr>
            <ng-container *ngIf="expanded[step.id] === StepDetailTab.Item">
              <tr
                class="details first"
                *ngIf="vm.stepDetails[step.id].outputs.length"
              >
                <td [colSpan]="leftSpan"></td>
                <td colspan="100">
                  <span class="header">{{ 'list.sources' | translate }}</span>
                </td>
              </tr>
              <tr
                *ngFor="
                  let output of vm.stepDetails[step.id].outputs;
                  last as isLast;
                  trackBy: trackSvc.trackById
                "
                class="details"
                [class.last]="isLast && !step.parents"
              >
                <ng-container *ngIf="output.outputs && step.itemId">
                  <ng-container *ngIf="output.outputs[step.itemId] as value">
                    <td [colSpan]="leftSpan"></td>
                    <td>
                      <div class="flex">
                        <span *ngIf="step.items" class="monospace">{{
                          step.items.mul(value)
                            | rate: vm.effectivePrecision[Column.Items]
                        }}</span>
                        <lab-icon
                          [iconId]="step.itemId"
                          [tooltip]="vm.data.itemEntities[step.itemId].name"
                          [recipe]="
                            vm.data.recipeEntities[
                              vm.data.itemRecipeId[step.itemId]
                            ]
                          "
                        >
                        </lab-icon>
                      </div>
                    </td>
                    <td *ngIf="vm.columns[Column.Belts].show">
                      <ng-container
                        *ngIf="vm.itemSettings[step.itemId].beltId as beltId"
                      >
                        <div *ngIf="step.belts" class="flex">
                          <span class="monospace">{{
                            step.belts.mul(value)
                              | rate: vm.effectivePrecision[Column.Belts]
                          }}</span>
                          <lab-icon
                            [iconId]="beltId"
                            [tooltip]="
                              vm.data.itemEntities[beltId]?.name || PIPE
                            "
                            [item]="vm.data.itemEntities[beltId]"
                          ></lab-icon>
                        </div>
                      </ng-container>
                    </td>
                    <td *ngIf="vm.columns[Column.Wagons].show">
                      <ng-container
                        *ngIf="vm.itemSettings[step.itemId].wagonId as wagonId"
                      >
                        <div *ngIf="step.wagons" class="flex">
                          <span class="monospace">{{
                            step.wagons.mul(value)
                              | rate: vm.effectivePrecision[Column.Wagons]
                          }}</span>
                          <lab-icon
                            [iconId]="wagonId"
                            [tooltip]="vm.data.itemEntities[wagonId].name"
                            [item]="vm.data.itemEntities[wagonId]"
                          ></lab-icon>
                        </div>
                      </ng-container>
                    </td>
                    <ng-container *ngIf="output.recipeId; else noRecipeDetail">
                      <ng-container
                        *ngIf="
                          vm.recipeSettings[output.recipeId]
                            .factoryId as factoryId
                        "
                      >
                        <td>
                          <div
                            class="flex"
                            *ngIf="
                              output.factories && output.factories.nonzero()
                            "
                          >
                            <span class="monospace">{{
                              output.factories
                                | factoryRate
                                  : vm.effectivePrecision[Column.Factories]
                                  : factoryId
                            }}</span>
                          </div>
                        </td>
                        <td class="split-column">
                          <div>
                            <div class="flex">
                              <lab-icon
                                [iconId]="output.recipeId"
                                [tooltip]="
                                  vm.data.recipeEntities[output.recipeId].name
                                "
                                [recipe]="
                                  vm.data.recipeEntities[output.recipeId]
                                "
                              ></lab-icon>
                              <lab-icon
                                *ngIf="
                                  vm.data.game !== Game.DysonSphereProgram ||
                                  factoryId !== ItemId.MiningDrill
                                "
                                [iconId]="factoryId"
                                [tooltip]="vm.data.itemEntities[factoryId].name"
                                [item]="vm.data.itemEntities[factoryId]"
                              ></lab-icon>
                            </div>
                          </div>
                        </td>
                      </ng-container>
                    </ng-container>
                    <td class="split-column" colspan="100">
                      <div>
                        <div class="flex percent">
                          <i class="material-icons">arrow_forward</i>
                          <span class="monospace"
                            >{{ value | rate: -2 | leftPad }}%</span
                          >
                          <lab-icon
                            [iconId]="step.itemId"
                            [tooltip]="vm.data.itemEntities[step.itemId].name"
                            [item]="vm.data.itemEntities[step.itemId]"
                          ></lab-icon>
                        </div>
                      </div>
                    </td>
                  </ng-container>
                </ng-container>
              </tr>
              <tr class="details" *ngIf="step.parents">
                <td [colSpan]="leftSpan"></td>
                <td colspan="100">
                  <span class="header">{{
                    'list.destinations' | translate
                  }}</span>
                </td>
              </tr>
              <tr
                *ngFor="
                  let parent of step.parents | keyvalue: trackSvc.sortByValue;
                  last as isLast;
                  trackBy: trackSvc.trackByKey
                "
                class="details"
                [class.last]="isLast"
              >
                <ng-container *ngIf="step.itemId">
                  <td [colSpan]="leftSpan"></td>
                  <td>
                    <div class="flex">
                      <span *ngIf="step.items" class="monospace">{{
                        step.items.mul(parent.value)
                          | rate: vm.effectivePrecision[Column.Items]
                      }}</span>
                      <lab-icon
                        [iconId]="step.itemId"
                        [tooltip]="vm.data.itemEntities[step.itemId].name"
                        [recipe]="
                          vm.data.recipeEntities[
                            vm.data.itemRecipeId[step.itemId]
                          ]
                        "
                      >
                      </lab-icon>
                    </div>
                  </td>
                  <td *ngIf="vm.columns[Column.Belts].show">
                    <ng-container
                      *ngIf="vm.itemSettings[step.itemId].beltId as beltId"
                    >
                      <div *ngIf="step.belts" class="flex">
                        <span class="monospace">{{
                          step.belts.mul(parent.value)
                            | rate: vm.effectivePrecision[Column.Belts]
                        }}</span>
                        <lab-icon
                          [iconId]="beltId"
                          [tooltip]="vm.data.itemEntities[beltId]?.name ?? PIPE"
                          [item]="vm.data.itemEntities[beltId]"
                        ></lab-icon>
                      </div>
                    </ng-container>
                  </td>
                  <td *ngIf="vm.columns[Column.Wagons].show">
                    <ng-container
                      *ngIf="vm.itemSettings[step.itemId].wagonId as wagonId"
                    >
                      <div *ngIf="step.wagons" class="flex">
                        <span class="monospace">{{
                          step.wagons.mul(parent.value)
                            | rate: vm.effectivePrecision[Column.Wagons]
                        }}</span>
                        <lab-icon
                          [iconId]="wagonId"
                          [tooltip]="vm.data.itemEntities[wagonId].name"
                          [item]="vm.data.itemEntities[wagonId]"
                        ></lab-icon>
                      </div>
                    </ng-container>
                  </td>
                  <ng-container
                    *ngIf="
                      step.recipeId &&
                        vm.stepDetails[step.id].outputs.length === 1;
                      else noRecipeDetail
                    "
                  >
                    <ng-container
                      *ngIf="
                        vm.recipeSettings[step.recipeId].factoryId as factoryId
                      "
                    >
                      <td>
                        <div
                          class="flex"
                          *ngIf="step.factories && step.factories.nonzero()"
                        >
                          <span class="monospace">{{
                            step.factories.mul(parent.value)
                              | factoryRate
                                : vm.effectivePrecision[Column.Factories]
                                : factoryId
                          }}</span>
                        </div>
                      </td>
                      <td class="split-column">
                        <div>
                          <div class="flex">
                            <lab-icon
                              [iconId]="step.recipeId"
                              [tooltip]="
                                vm.data.recipeEntities[step.recipeId].name
                              "
                              [recipe]="vm.data.recipeEntities[step.recipeId]"
                            ></lab-icon>
                            <lab-icon
                              *ngIf="
                                vm.data.game !== Game.DysonSphereProgram ||
                                factoryId !== ItemId.MiningDrill
                              "
                              [iconId]="factoryId"
                              [tooltip]="vm.data.itemEntities[factoryId].name"
                              [item]="vm.data.itemEntities[factoryId]"
                            ></lab-icon>
                          </div>
                        </div>
                      </td>
                    </ng-container>
                  </ng-container>
                  <td class="split-column" colspan="100">
                    <div>
                      <div class="flex percent">
                        <span class="monospace"
                          >{{ parent.value | rate: -2 | leftPad }}%</span
                        >
                        <i class="material-icons">arrow_forward</i>
                        <lab-icon
                          [iconId]="parent.key"
                          [tooltip]="vm.data.recipeEntities[parent.key].name"
                          [recipe]="vm.data.recipeEntities[parent.key]"
                        ></lab-icon>
                      </div>
                    </div>
                  </td>
                </ng-container>
              </tr>
            </ng-container>
            <ng-container *ngIf="expanded[step.id] === StepDetailTab.Recipe">
              <ng-container *ngIf="step.recipeId">
                <ng-container
                  *ngIf="
                    vm.recipeSettings[step.recipeId].factoryId as factoryId
                  "
                >
                  <ng-container *ngIf="vm.data.game === Game.Factorio">
                    <ng-container
                      *ngIf="vm.data.itemEntities[factoryId].factory?.mining"
                    >
                      <tr class="details first">
                        <td [colSpan]="leftSpan"></td>
                        <td colspan="100">
                          <span class="header">{{
                            'list.depletion' | translate
                          }}</span>
                        </td>
                      </tr>
                      <ng-container
                        *ngFor="
                          let output of step.outputs
                            | keyvalue: trackSvc.sortByValue;
                          trackBy: trackSvc.trackByKey
                        "
                      >
                        <ng-container
                          *ngIf="vm.stepByItemEntities[output.key] as outStep"
                        >
                          <tr
                            *ngIf="step.outputs?.[output.key] as percent"
                            class="details"
                          >
                            <td [colSpan]="leftSpan"></td>
                            <td>
                              <div *ngIf="outStep.items" class="flex">
                                <span
                                  *ngIf="
                                    vm.data.recipeR[step.recipeId]
                                      .productivity as productivity
                                  "
                                  class="monospace"
                                  >{{
                                    outStep.items.mul(percent).div(productivity)
                                      | rate
                                        : vm.effectivePrecision[Column.Items]
                                  }}</span
                                >
                                <lab-icon
                                  [iconId]="output.key"
                                  [tooltip]="
                                    vm.data.itemEntities[output.key].name
                                  "
                                  [recipe]="
                                    vm.data.recipeEntities[
                                      vm.data.itemRecipeId[output.key]
                                    ]
                                  "
                                >
                                </lab-icon>
                              </div>
                            </td>
                            <td colspan="100"></td>
                          </tr>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                  <tr
                    class="details"
                    *ngIf="vm.data.recipeR[step.recipeId].in"
                    [class.first]="
                      vm.data.game !== Game.Factorio ||
                      !vm.data.itemEntities[factoryId].factory?.mining
                    "
                  >
                    <td [colSpan]="leftSpan"></td>
                    <td colspan="100">
                      <span class="header">{{
                        'list.inputs' | translate
                      }}</span>
                    </td>
                  </tr>
                  <ng-container
                    *ngFor="
                      let input of vm.data.recipeR[step.recipeId].in
                        | keyvalue: trackSvc.sortByValue;
                      trackBy: trackSvc.trackByKey
                    "
                  >
                    <ng-container
                      *ngIf="vm.stepByItemEntities[input.key] as inStep"
                    >
                      <tr
                        *ngIf="inStep.parents?.[step.recipeId] as percent"
                        class="details"
                      >
                        <td [colSpan]="leftSpan"></td>
                        <td>
                          <div class="flex">
                            <span *ngIf="inStep.items" class="monospace">{{
                              inStep.items.mul(percent)
                                | rate: vm.effectivePrecision[Column.Items]
                            }}</span>
                            <lab-icon
                              [iconId]="input.key"
                              [tooltip]="vm.data.itemEntities[input.key].name"
                              [recipe]="
                                vm.data.recipeEntities[
                                  vm.data.itemRecipeId[input.key]
                                ]
                              "
                            >
                            </lab-icon>
                          </div>
                        </td>
                        <td *ngIf="vm.columns[Column.Belts].show">
                          <ng-container *ngIf="inStep.itemId">
                            <ng-container
                              *ngIf="
                                vm.itemSettings[inStep.itemId].beltId as beltId
                              "
                            >
                              <div *ngIf="inStep.belts" class="flex">
                                <span class="monospace">{{
                                  inStep.belts.mul(percent)
                                    | rate: vm.effectivePrecision[Column.Belts]
                                }}</span>
                                <lab-icon
                                  [iconId]="beltId"
                                  [tooltip]="
                                    vm.data.itemEntities[beltId]?.name || PIPE
                                  "
                                  [item]="vm.data.itemEntities[beltId]"
                                ></lab-icon>
                              </div>
                            </ng-container>
                          </ng-container>
                        </td>
                        <td *ngIf="vm.columns[Column.Wagons].show">
                          <ng-container *ngIf="inStep.itemId">
                            <ng-container
                              *ngIf="
                                vm.itemSettings[inStep.itemId]
                                  .wagonId as wagonId
                              "
                            >
                              <div *ngIf="inStep.wagons" class="flex">
                                <span class="monospace">{{
                                  inStep.wagons.mul(percent)
                                    | rate: vm.effectivePrecision[Column.Wagons]
                                }}</span>
                                <lab-icon
                                  [iconId]="wagonId"
                                  [tooltip]="vm.data.itemEntities[wagonId].name"
                                  [item]="vm.data.itemEntities[wagonId]"
                                ></lab-icon>
                              </div>
                            </ng-container>
                          </ng-container>
                        </td>
                        <ng-container
                          *ngIf="inStep.recipeId; else noRecipeDetail"
                        >
                          <ng-container
                            *ngIf="
                              vm.recipeSettings[inStep.recipeId]
                                .factoryId as factoryId
                            "
                          >
                            <td>
                              <div
                                class="flex"
                                *ngIf="
                                  inStep.factories && inStep.factories.nonzero()
                                "
                              >
                                <span class="monospace">{{
                                  inStep.factories.mul(percent)
                                    | factoryRate
                                      : vm.effectivePrecision[Column.Factories]
                                      : factoryId
                                }}</span>
                              </div>
                            </td>
                            <td class="split-column">
                              <div>
                                <div class="flex">
                                  <lab-icon
                                    [iconId]="inStep.recipeId"
                                    [tooltip]="
                                      vm.data.recipeEntities[inStep.recipeId]
                                        .name
                                    "
                                    [recipe]="
                                      vm.data.recipeEntities[inStep.recipeId]
                                    "
                                  >
                                  </lab-icon>
                                  <lab-icon
                                    *ngIf="
                                      vm.data.game !==
                                        Game.DysonSphereProgram ||
                                      factoryId !== ItemId.MiningDrill
                                    "
                                    [iconId]="factoryId"
                                    [tooltip]="
                                      vm.data.itemEntities[factoryId].name
                                    "
                                    [item]="vm.data.itemEntities[factoryId]"
                                  ></lab-icon>
                                </div>
                              </div>
                            </td>
                          </ng-container>
                        </ng-container>
                        <td class="split-column" colspan="100">
                          <div>
                            <div class="flex percent">
                              <span class="monospace"
                                >{{ percent | rate: -2 | leftPad }}%</span
                              >
                              <i class="material-icons">arrow_forward</i>
                              <lab-icon
                                [iconId]="step.recipeId"
                                [tooltip]="
                                  vm.data.recipeEntities[step.recipeId].name
                                "
                                [recipe]="vm.data.recipeEntities[step.recipeId]"
                              ></lab-icon>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>
                  <tr class="details">
                    <td [colSpan]="leftSpan"></td>
                    <td colspan="100">
                      <span class="header">{{
                        'list.outputs' | translate
                      }}</span>
                    </td>
                  </tr>
                  <ng-container
                    *ngFor="
                      let output of step.outputs
                        | keyvalue: trackSvc.sortByValue;
                      last as isLast;
                      trackBy: trackSvc.trackByKey
                    "
                  >
                    <ng-container
                      *ngIf="vm.stepByItemEntities[output.key] as outStep"
                    >
                      <tr
                        *ngIf="step.outputs?.[output.key] as percent"
                        class="details"
                        [class.last]="isLast"
                      >
                        <td [colSpan]="leftSpan"></td>
                        <td>
                          <div *ngIf="outStep.items" class="flex">
                            <span class="monospace">{{
                              outStep.items.mul(percent)
                                | rate: vm.effectivePrecision[Column.Items]
                            }}</span>
                            <lab-icon
                              [iconId]="output.key"
                              [tooltip]="vm.data.itemEntities[output.key].name"
                              [recipe]="
                                vm.data.recipeEntities[
                                  vm.data.itemRecipeId[output.key]
                                ]
                              "
                            >
                            </lab-icon>
                          </div>
                        </td>
                        <td *ngIf="vm.columns[Column.Belts].show">
                          <ng-container *ngIf="outStep.itemId">
                            <ng-container
                              *ngIf="
                                vm.itemSettings[outStep.itemId].beltId as beltId
                              "
                            >
                              <div *ngIf="outStep.belts" class="flex">
                                <span class="monospace">{{
                                  outStep.belts.mul(percent)
                                    | rate: vm.effectivePrecision[Column.Belts]
                                }}</span>
                                <lab-icon
                                  [iconId]="beltId"
                                  [tooltip]="
                                    vm.data.itemEntities[beltId]?.name || PIPE
                                  "
                                  [item]="vm.data.itemEntities[beltId]"
                                ></lab-icon>
                              </div>
                            </ng-container>
                          </ng-container>
                        </td>
                        <td *ngIf="vm.columns[Column.Wagons].show">
                          <ng-container *ngIf="outStep.itemId">
                            <ng-container
                              *ngIf="
                                vm.itemSettings[outStep.itemId]
                                  ?.wagonId as wagonId
                              "
                            >
                              <div *ngIf="outStep.wagons" class="flex">
                                <span class="monospace">{{
                                  outStep.wagons.mul(percent)
                                    | rate: vm.effectivePrecision[Column.Wagons]
                                }}</span>
                                <lab-icon
                                  [iconId]="wagonId"
                                  [tooltip]="vm.data.itemEntities[wagonId].name"
                                  [item]="vm.data.itemEntities[wagonId]"
                                ></lab-icon>
                              </div>
                            </ng-container>
                          </ng-container>
                        </td>
                        <ng-container
                          *ngIf="outStep.recipeId; else noRecipeDetail"
                        >
                          <ng-container
                            *ngIf="
                              vm.recipeSettings[outStep.recipeId]
                                .factoryId as factoryId
                            "
                          >
                            <td>
                              <div
                                class="flex"
                                *ngIf="
                                  outStep.factories &&
                                  outStep.factories.nonzero()
                                "
                              >
                                <span class="monospace">{{
                                  outStep.factories
                                    | factoryRate
                                      : vm.effectivePrecision[Column.Factories]
                                      : factoryId
                                }}</span>
                              </div>
                            </td>
                            <td class="split-column">
                              <div>
                                <div class="flex">
                                  <lab-icon
                                    [iconId]="outStep.recipeId"
                                    [tooltip]="
                                      vm.data.recipeEntities[outStep.recipeId]
                                        .name
                                    "
                                    [recipe]="
                                      vm.data.recipeEntities[outStep.recipeId]
                                    "
                                  ></lab-icon>
                                  <lab-icon
                                    *ngIf="
                                      vm.data.game !==
                                        Game.DysonSphereProgram ||
                                      factoryId !== ItemId.MiningDrill
                                    "
                                    [iconId]="factoryId"
                                    [tooltip]="
                                      vm.data.itemEntities[factoryId].name
                                    "
                                    [item]="vm.data.itemEntities[factoryId]"
                                  ></lab-icon>
                                </div>
                              </div>
                            </td>
                          </ng-container>
                        </ng-container>
                        <td class="split-column" colspan="100">
                          <div>
                            <div class="flex percent">
                              <i class="material-icons">arrow_forward</i>
                              <span class="monospace"
                                >{{ percent | rate: -2 | leftPad }}%</span
                              >
                              <lab-icon
                                [iconId]="output.key"
                                [tooltip]="
                                  vm.data.itemEntities[output.key].name
                                "
                                [item]="vm.data.itemEntities[output.key]"
                              ></lab-icon>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
            <tr
              *ngIf="expanded[step.id] === StepDetailTab.Factory"
              class="details first last"
            >
              <td [colSpan]="leftSpan"></td>
              <td colspan="100" class="factory">
                <div *ngIf="step.recipeId && step.factories">
                  <table>
                    <ng-container
                      *ngFor="
                        let input of vm.data.recipeR[step.recipeId].in
                          | keyvalue: trackSvc.sortByValue;
                        trackBy: trackSvc.trackByKey
                      "
                    >
                      <ng-container
                        *ngIf="vm.stepByItemEntities[input.key] as inStep"
                      >
                        <tr *ngIf="inStep.parents?.[step.recipeId] as percent">
                          <td>
                            <div class="flex" *ngIf="inStep.items">
                              <span class="monospace">{{
                                inStep.items.mul(percent).div(step.factories)
                                  | rate: vm.effectivePrecision[Column.Items]
                              }}</span>
                              <lab-icon
                                [iconId]="input.key"
                                [tooltip]="vm.data.itemEntities[input.key].name"
                                [recipe]="
                                  vm.data.recipeEntities[
                                    vm.data.itemRecipeId[input.key]
                                  ]
                                "
                              >
                              </lab-icon>
                            </div>
                          </td>
                          <td
                            [colSpan]="
                              vm.itemSettings[input.key].beltId === ItemId.Pipe
                                ? 2
                                : 0
                            "
                          >
                            <ng-container
                              *ngIf="vm.itemSettings[input.key].beltId as belt"
                            >
                              <div *ngIf="inStep.belts" class="flex">
                                <span class="monospace">{{
                                  inStep.belts.mul(percent).div(step.factories)
                                    | rate: vm.effectivePrecision[Column.Belts]
                                }}</span>
                                <lab-icon
                                  [iconId]="belt"
                                  [tooltip]="
                                    vm.data.itemEntities[belt]?.name || PIPE
                                  "
                                  [item]="vm.data.itemEntities[belt]"
                                ></lab-icon>
                              </div>
                            </ng-container>
                          </td>
                          <ng-container
                            *ngIf="
                              vm.data.game === Game.Factorio &&
                              vm.itemSettings[input.key].beltId !==
                                ItemId.Pipe &&
                              inStep.items
                            "
                          >
                            <td
                              *ngIf="
                                inStep.items
                                  .mul(percent)
                                  .div(step.factories)
                                  .div(DisplayRateVal[vm.settings.displayRate])
                                  | inserterSpeed: vm.settings as ins
                              "
                            >
                              <div class="flex">
                                <span class="monospace">{{
                                  ins.value | rate: 1
                                }}</span>
                                <lab-icon
                                  [iconId]="ins.id"
                                  [tooltip]="vm.data.itemEntities[ins.id].name"
                                  [item]="vm.data.itemEntities[ins.id]"
                                ></lab-icon>
                              </div>
                            </td>
                          </ng-container>
                        </tr>
                      </ng-container>
                    </ng-container>
                  </table>
                  <i class="material-icons">arrow_forward</i>
                  <table>
                    <tr>
                      <td>
                        <div class="flex"><span class="monospace">1</span></div>
                      </td>
                      <td class="split-column">
                        <div
                          *ngIf="
                            vm.recipeSettings[step.recipeId]
                              ?.factoryId as factory
                          "
                        >
                          <div class="flex">
                            <lab-icon
                              [iconId]="step.recipeId"
                              [tooltip]="
                                vm.data.recipeEntities[step.recipeId].name
                              "
                              [recipe]="vm.data.recipeEntities[step.recipeId]"
                            ></lab-icon>
                            <lab-icon
                              [iconId]="factory"
                              [tooltip]="vm.data.itemEntities[factory].name"
                              [item]="vm.data.itemEntities[factory]"
                            ></lab-icon>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </table>
                  <i class="material-icons">arrow_forward</i>
                  <table>
                    <ng-container
                      *ngFor="
                        let output of vm.data.recipeR[step.recipeId].out
                          | keyvalue: trackSvc.sortByValue;
                        trackBy: trackSvc.trackByKey
                      "
                    >
                      <tr
                        *ngIf="
                          output.value.div(
                            vm.data.recipeR[step.recipeId].time
                          ) as items
                        "
                      >
                        <ng-container
                          *ngIf="
                            vm.data.game === Game.Factorio &&
                            vm.itemSettings[output.key].beltId !== ItemId.Pipe
                          "
                        >
                          <td *ngIf="items | inserterSpeed: vm.settings as ins">
                            <div class="flex">
                              <span class="monospace">{{
                                ins.value | rate: 1
                              }}</span>
                              <lab-icon
                                [iconId]="ins.id"
                                [tooltip]="vm.data.itemEntities[ins.id].name"
                                [item]="vm.data.itemEntities[ins.id]"
                              ></lab-icon>
                            </div>
                          </td>
                        </ng-container>
                        <td
                          [colSpan]="
                            vm.itemSettings[output.key].beltId === ItemId.Pipe
                              ? 2
                              : 0
                          "
                        >
                          <div
                            *ngIf="vm.itemSettings[output.key].beltId as belt"
                            class="flex"
                          >
                            <span class="monospace">{{
                              items.div(vm.beltSpeed[belt])
                                | rate: vm.effectivePrecision[Column.Belts]
                            }}</span>
                            <lab-icon
                              [iconId]="belt"
                              [tooltip]="
                                vm.data.itemEntities[belt]?.name || PIPE
                              "
                              [item]="vm.data.itemEntities[belt]"
                            >
                            </lab-icon>
                          </div>
                        </td>
                        <td>
                          <div class="flex">
                            <span class="monospace">{{
                              items.mul(DisplayRateVal[vm.settings.displayRate])
                                | rate: vm.effectivePrecision[Column.Items]
                            }}</span>
                            <lab-icon
                              [iconId]="output.key"
                              [tooltip]="vm.data.itemEntities[output.key].name"
                              [recipe]="
                                vm.data.recipeEntities[
                                  vm.data.itemRecipeId[output.key]
                                ]
                              "
                            >
                            </lab-icon>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </table>
                </div>
                <div class="info" *ngIf="vm.data.game === Game.Factorio">
                  <span>
                    {{ 'list.insertCalculateRemark' | translate }}
                    <a
                      href="https://wiki.factorio.com/Inserters#Inserter_Throughput"
                      >wiki.</a
                    >
                  </span>
                </div>
              </td>
            </tr>
            <ng-container *ngIf="expanded[step.id] === StepDetailTab.Recipes">
              <ng-container
                *ngIf="vm.stepDetails[step.id].defaultableRecipeIds.length"
              >
                <tr class="details first">
                  <td [colSpan]="leftSpan"></td>
                  <td colspan="100">
                    <div>
                      <div class="header">
                        {{ 'list.defaultRecipe' | translate }}
                      </div>
                      <div class="info">
                        {{ 'list.defaultRecipeInfo1' | translate }}
                      </div>
                      <div class="info">
                        {{ 'list.defaultRecipeInfo2' | translate }}
                      </div>
                      <div
                        class="info warn"
                        *ngIf="
                          step.itemId &&
                          vm.data.itemRecipeId[step.itemId] === null
                        "
                      >
                        {{ 'list.defaultRecipeInfo3' | translate }}
                      </div>
                    </div>
                  </td>
                </tr>
                <tr class="details" *ngIf="step.itemId">
                  <td [colSpan]="leftSpan"></td>
                  <td colspan="100" class="recipes">
                    <div class="list tile">
                      <ng-container
                        *ngFor="
                          let recipeId of vm.stepDetails[step.id]
                            .defaultableRecipeIds
                        "
                      >
                        <lab-icon
                          class="button grid"
                          [class.selected]="
                            vm.data.itemRecipeId[step.itemId] === recipeId
                          "
                          [iconId]="recipeId"
                          [tooltip]="vm.data.recipeEntities[recipeId].name"
                          [recipe]="vm.data.recipeEntities[recipeId]"
                          (click)="
                            toggleDefaultRecipe(
                              step.itemId,
                              recipeId,
                              vm.itemSettings,
                              vm.settings,
                              vm.data
                            )
                          "
                        >
                        </lab-icon>
                      </ng-container>
                    </div>
                  </td>
                </tr>
              </ng-container>
              <tr class="details">
                <td [colSpan]="leftSpan"></td>
                <td colspan="100">
                  <div>
                    <div class="header">
                      {{ 'list.enabledRecipes' | translate }}
                    </div>
                    <div class="info">
                      {{ 'list.enabledRecipesInfo' | translate }}
                    </div>
                  </div>
                </td>
              </tr>
              <tr class="details last">
                <td [colSpan]="leftSpan"></td>
                <td colspan="100" class="recipes">
                  <div class="list tile">
                    <lab-icon
                      *ngFor="let recipeId of vm.stepDetails[step.id].recipeIds"
                      class="button grid"
                      [class.ignored]="
                        vm.settings.disabledRecipeIds.indexOf(recipeId) !== -1
                      "
                      [iconId]="recipeId"
                      [tooltip]="vm.data.recipeEntities[recipeId].name"
                      [recipe]="vm.data.recipeEntities[recipeId]"
                      (click)="toggleRecipe(recipeId, vm.settings, vm.data)"
                    ></lab-icon>
                  </div>
                </td>
              </tr>
            </ng-container>
            <ng-template #noRecipeDetail>
              <td colspan="2"></td>
            </ng-template>
            <tr class="spacer">
              <td></td>
            </tr>
          </ng-container>
        </ng-container>
      </ng-container>
      <tr *ngIf="mode === ListMode.All" class="border row col">
        <td [colSpan]="leftSpan + 1">
          <div class="flex summary-label">
            <span class="monospace">{{ 'list.total' | translate }}:</span>
          </div>
        </td>
        <td *ngIf="vm.columns[Column.Belts].show">
          <div
            class="flex"
            *ngFor="
              let tot of vm.totals.belts | keyvalue: trackSvc.sortByValue;
              trackBy: trackSvc.trackByKey
            "
          >
            <span class="monospace">{{
              tot.value | rate: vm.effectivePrecision[Column.Belts]
            }}</span>
            <lab-icon
              *ngIf="vm.data.itemEntities[tot.key] as item"
              [iconId]="tot.key"
              [tooltip]="item.name"
              [item]="item"
            >
            </lab-icon>
          </div>
        </td>
        <td *ngIf="vm.columns[Column.Wagons].show">
          <div
            class="flex"
            *ngFor="
              let tot of vm.totals.wagons | keyvalue: trackSvc.sortByValue;
              trackBy: trackSvc.trackByKey
            "
          >
            <span class="monospace">{{
              tot.value | rate: vm.effectivePrecision[Column.Wagons]
            }}</span>
            <lab-icon
              *ngIf="vm.data.itemEntities[tot.key] as item"
              [iconId]="tot.key"
              [tooltip]="item.name"
              [item]="item"
            >
            </lab-icon>
          </div>
        </td>
        <td colspan="3">
          <div
            class="flex"
            *ngFor="
              let tot of vm.totals.factories | keyvalue: trackSvc.sortByValue;
              trackBy: trackSvc.trackByKey
            "
          >
            <span class="monospace">{{
              tot.value | rate: vm.effectivePrecision[Column.Factories]
            }}</span>
            <lab-icon
              *ngIf="vm.data.itemEntities[tot.key] as item; else totalRecipe"
              [iconId]="tot.key"
              [tooltip]="item.name"
              [item]="item"
            >
            </lab-icon>
            <ng-template #totalRecipe>
              <lab-icon
                *ngIf="vm.data.recipeEntities[tot.key] as recipe"
                [iconId]="tot.key"
                [tooltip]="recipe.name"
                [recipe]="recipe"
              >
              </lab-icon>
            </ng-template>
          </div>
        </td>
        <td *ngIf="vm.columns[Column.Overclock].show"></td>
        <td colspan="3" *ngIf="vm.columns[Column.Beacons].show">
          <div
            class="flex"
            *ngFor="
              let tot of vm.totals.beacons | keyvalue: trackSvc.sortByValue;
              trackBy: trackSvc.trackByKey
            "
          >
            <span class="monospace">{{ tot.value | rate: 0 }}</span>
            <lab-icon
              *ngIf="vm.data.itemEntities[tot.key] as item"
              [iconId]="tot.key"
              [tooltip]="item.name"
              [item]="item"
            >
            </lab-icon>
          </div>
        </td>
        <td *ngIf="vm.columns[Column.Power].show">
          <div class="flex">
            <span class="monospace">{{
              vm.totals.power
                | power
                  : vm.effectivePrecision[Column.Power]
                  : vm.effectivePowerUnit
            }}</span>
          </div>
        </td>
        <td *ngIf="vm.columns[Column.Pollution].show">
          <div class="flex">
            <span class="monospace">{{
              vm.totals.pollution
                | rate: vm.effectivePrecision[Column.Pollution]
            }}</span>
          </div>
        </td>
        <td *ngIf="vm.columns[Column.Link].show"></td>
      </tr>
      <tr *ngIf="mode === ListMode.Focus && selectedId == null">
        <td colspan="100" class="message">
          {{ 'list.selectANodeToSeeDetails' | translate }}
        </td>
      </tr>
    </tbody>
  </table>
</ng-container>
